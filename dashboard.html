<!DOCTYPE html>
<html>
<head>
    <title>ECS Infrastructure Monitor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2c3e50 0%, #34495e 25%, #2c3e50 50%, #34495e 75%, #2c3e50 100%); background-size: 400% 400%; animation: gradientShift 15s ease infinite; min-height: 100vh; margin: 0; display: flex; }
        .sidebar { width: 250px; background: rgba(44,62,80,0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); position: fixed; height: 100vh; z-index: 100; transition: all 0.3s; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-title { color: #74b9ff; font-size: 1.3em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .sidebar-nav { padding: 20px 0; }
        .nav-item { display: block; padding: 15px 25px; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; border-left-color: #74b9ff; }
        .nav-item.active { background: rgba(116,185,255,0.2); color: #74b9ff; border-left-color: #74b9ff; }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }
        .main-content { margin-left: 250px; flex: 1; padding: 20px; }
        .sidebar-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 101; background: rgba(116,185,255,0.2); color: #74b9ff; border: 1px solid rgba(116,185,255,0.4); padding: 10px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(10px); }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { display: block; }
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container { max-width: 1400px; margin: 0 auto; width: 100%; }
        .header { text-align: center; color: #2c3e50; margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); color: white; }
        .header p { color: rgba(255,255,255,0.9); font-size: 1.1em; }
        .add-account-form { background: rgba(52,73,94,0.8); border-radius: 25px; padding: 35px; margin-bottom: 35px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .add-account-form h3 { color: #74b9ff; margin-bottom: 25px; font-size: 1.4em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-grid input, .form-grid select { padding: 15px; border: none; border-radius: 15px; font-size: 14px; transition: all 0.3s; background: rgba(44,62,80,0.6); color: #ecf0f1; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .form-grid input::placeholder { color: #bdc3c7; }
        .form-grid select option { background: #2c3e50; color: #ecf0f1; }
        .form-grid input:focus, .form-grid select:focus { outline: none; background: rgba(44,62,80,0.8); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); border-color: rgba(116,185,255,0.5); }
        .add-btn { background: rgba(116,185,255,0.2); color: #74b9ff; border: 1px solid rgba(116,185,255,0.4); padding: 15px 35px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; backdrop-filter: blur(10px); }
        .add-btn:hover { transform: translateY(-3px); background: rgba(116,185,255,0.3); box-shadow: 0 8px 25px rgba(116,185,255,0.2); }
        .account-card { background: rgba(255,255,255,0.1); border-radius: 25px; margin-bottom: 35px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .account-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .account-header h2 { font-size: 1.6em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .account-id { background: rgba(255,255,255,0.25); padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; backdrop-filter: blur(10px); }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 0.85em; font-weight: bold; text-transform: uppercase; }
        .status.active { background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; box-shadow: 0 3px 10px rgba(46,204,113,0.3); }
        .status.inactive { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; box-shadow: 0 3px 10px rgba(231,76,60,0.3); }
        .clusters-container { padding: 30px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .cluster-card { background: rgba(52,73,94,0.8); border-radius: 20px; margin-bottom: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .cluster-header { display: flex; justify-content: space-between; align-items: center; padding: 25px; cursor: pointer; transition: all 0.3s; }
        .cluster-header:hover { background: rgba(255,255,255,0.05); }
        .cluster-name { color: #74b9ff; font-size: 1.4em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 0; margin-bottom: 20px;}
        .cluster-toggle { color: #74b9ff; font-size: 1.2em; transition: transform 0.3s; }
        .cluster-toggle.expanded { transform: rotate(90deg); }
        .cluster-content { padding: 0 25px 25px 25px; display: none; }
        .cluster-content.expanded { display: block; }
        .cluster-stats { display: flex; gap: 20px; font-size: 0.9em; color: #bdc3c7; }
        .cluster-stat { background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 10px; backdrop-filter: blur(10px); }
        .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .service-card { background: rgba(44,62,80,0.7); border-radius: 20px; padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); transition: all 0.3s; color: #ecf0f1; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .service-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); background: rgba(44,62,80,0.9); }
        .service-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .service-header h4 { color: #74b9ff; font-size: 1.2em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .service-status { padding: 8px 15px; border-radius: 15px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .service-status.ACTIVE { background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid rgba(46,204,113,0.4); }
        .service-status.DRAINING { background: rgba(243,156,18,0.2); color: #f39c12; border: 1px solid rgba(243,156,18,0.4); }
        .info-icon { background: rgba(255,255,255,0.2); padding: 5px 8px; border-radius: 50%; backdrop-filter: blur(10px); transition: all 0.3s; }
        .info-icon:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .service-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .metric { text-align: center; background: rgba(52,73,94,0.6); padding: 15px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .metric-label { display: block; font-size: 0.85em; color: #bdc3c7; font-weight: 500; }
        .metric-value { display: block; font-weight: bold; color: #ecf0f1; font-size: 1.2em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .recommend-btn { background: rgba(116,185,255,0.2); color: #74b9ff; border: 1px solid rgba(116,185,255,0.4); padding: 12px 20px; border-radius: 25px; cursor: pointer; font-size: 0.9em; font-weight: bold; width: 100%; transition: all 0.3s; backdrop-filter: blur(10px); }
        .recommend-btn:hover { transform: translateY(-2px); background: rgba(116,185,255,0.3); box-shadow: 0 8px 25px rgba(116,185,255,0.2); }
        .account-actions { background: rgba(255,255,255,0.1); padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.2); }
        .account-recommend-btn { background: linear-gradient(45deg, #a29bfe, #6c5ce7); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; margin-right: 10px; font-weight: bold; transition: all 0.3s; box-shadow: 0 5px 15px rgba(162,155,254,0.3); }
        .account-recommend-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(162,155,254,0.4); }
        .refresh-btn { color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; margin-right: 10px; font-weight: bold; transition: all 0.3s; }
        .refresh-btn:nth-child(2) { background: linear-gradient(45deg, #00cec9, #00b894); box-shadow: 0 5px 15px rgba(0,206,201,0.3); }
        .refresh-btn:nth-child(2):hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,206,201,0.4); }
        .refresh-btn:nth-child(3) { background: linear-gradient(45deg, #fd79a8, #e84393); box-shadow: 0 5px 15px rgba(253,121,168,0.3); }
        .refresh-btn:nth-child(3):hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(253,121,168,0.4); }
        .refresh-btn:nth-child(4) { background: linear-gradient(45deg, #fdcb6e, #e17055); box-shadow: 0 5px 15px rgba(253,203,110,0.3); }
        .refresh-btn:nth-child(4):hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(253,203,110,0.4); }
        .last-updated { color: #6c5ce7; font-size: 0.9em; font-weight: 500; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: rgba(44,62,80,0.95); margin: 3% auto; padding: 30px; border-radius: 25px; width: 85%; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); color: white; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .close { color: rgba(255,255,255,0.8); float: right; font-size: 32px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .close:hover { color: white; transform: scale(1.1); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.15); padding: 40px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; z-index: 1001; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); color: white; }
        .recommendations-summary { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .health-good { color: #4CAF50; }
        .health-warning { color: #ff9800; }
        .health-critical { color: #f44336; }
        .recommendations-list { margin-bottom: 20px; }
        .recommendation-item { background: #f5f5f5; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #667eea; }
        .severity-high { border-left-color: #f44336; }
        .severity-medium { border-left-color: #ff9800; }
        .severity-low { border-left-color: #4CAF50; }
        .error { color: #f44336; padding: 15px; background: #ffebee; border-radius: 5px; }
        .chat-container { background: linear-gradient(135deg, #fd79a8, #fdcb6e); border-radius: 20px; margin-top: 25px; box-shadow: 0 15px 35px rgba(253,121,168,0.2); overflow: hidden; }
        .chat-header { background: linear-gradient(45deg, #e17055, #d63031); color: white; padding: 20px 25px; }
        .chat-messages { height: 320px; overflow-y: auto; padding: 25px; border-bottom: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .chat-message { margin-bottom: 18px; }
        .chat-message.user { text-align: right; }
        .chat-message.ai { text-align: left; }
        .message-bubble { display: inline-block; max-width: 75%; padding: 18px 25px; border-radius: 20px; word-wrap: break-word; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .message-bubble.user { background: linear-gradient(45deg, #74b9ff, #0984e3); color: white; }
        .message-bubble.ai { background: rgba(255,255,255,0.95); color: #2d3436; line-height: 1.6; }
        .chat-input-container { padding: 20px 25px; display: flex; gap: 15px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .chat-input { flex: 1; padding: 15px 20px; border: none; border-radius: 25px; outline: none; background: rgba(255,255,255,0.9); font-size: 14px; }
        .chat-input:focus { background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .chat-send-btn { background: linear-gradient(45deg, #00b894, #00a085); color: white; border: none; padding: 15px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,184,148,0.3); }
        .chat-send-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,184,148,0.4); }
        .chat-send-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .recommendations-summary { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px); }
        .recommendations-list { margin-bottom: 25px; }
        .recommendation-item { background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 12px; border-radius: 12px; border-left: 5px solid #00b894; backdrop-filter: blur(10px); }
        .severity-high { border-left-color: #e74c3c; }
        .severity-medium { border-left-color: #f39c12; }
        .severity-low { border-left-color: #27ae60; }
        .error { color: #e74c3c; padding: 20px; background: rgba(231,76,60,0.1); border-radius: 12px; backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üèóÔ∏è ECS Monitor</div>
        </div>
        <nav class="sidebar-nav">
            <a href="/" class="nav-item">
                <i>üìà</i> Analytics
            </a>
            <a href="/services-dashboard" class="nav-item active">
                <i>üè†</i> Services
            </a>
            <a href="/dashboard-comparison" class="nav-item">
                <i>üîÑ</i> Switch Dashboard
            </a>
            <a href="/recommendations-dashboard" class="nav-item">
                <i>üìä</i> Recommendations
            </a>
            <a href="/add-account" class="nav-item">
                <i>‚ûï</i> Add Account
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h1>üèóÔ∏è ECS Services Dashboard</h1>
                    <p>AI-Powered Container Orchestration Management</p>
                </div>
                <div id="userInfo" style="text-align: right; color: rgba(255,255,255,0.9); font-size: 0.9em;">
                    <div style="background: rgba(255,255,255,0.15); padding: 12px 20px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                        <div style="font-weight: bold; margin-bottom: 4px;">üë§ <span id="userName">Loading...</span></div>
                        <div style="font-size: 0.85em; opacity: 0.8;">üìß <span id="userEmail">Loading...</span></div>
                    </div>
                </div>
            </div>
        </div>



        <div id="accounts"></div>
        </div>
    </div>

    <div id="loading"></div>

    <div id="recommendationsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="recommendationsTitle" style="margin-bottom: 20px;"></h2>
            <div id="recommendationsContent"></div>
            <div id="chatContainer" class="chat-container" style="display: none;">
                <div class="chat-header">
                    <h3>üí¨ Chat with AI Assistant</h3>
                    <p>Ask questions about these recommendations or discuss other ECS scenarios</p>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Ask about scaling, CPU optimization, or any ECS question..." onkeypress="handleChatKeyPress(event)">
                    <button id="chatSendBtn" class="chat-send-btn" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="serviceDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeServiceDetailsModal()">&times;</span>
            <h2 id="serviceDetailsTitle" style="margin-bottom: 20px;"></h2>
            <div id="serviceDetailsContent"></div>
        </div>
    </div>

    <script>


        async function loadAccounts() {
            const resp = await fetch('/accounts');
            const accounts = await resp.json();
            document.getElementById('accounts').innerHTML = accounts.map(acc =>
                `<div class="account-card">
                    <div class="account-header">
                        <h2>${acc.account_name || acc.account_id}</h2>
                        <span class="account-id">${acc.account_id}</span>
                        <span class="status ${acc.status}">${acc.status}</span>
                    </div>
                    <div class="clusters-container">
                        ${Object.entries(acc.cluster_details || {}).map(([cluster, services]) => {
                            const totalServices = services.length;
                            const activeServices = services.filter(s => s.status === 'ACTIVE').length;
                            const totalTasks = services.reduce((sum, s) => sum + s.running_count, 0);
                            const avgCpu = services.length > 0 ? Math.round(services.reduce((sum, s) => sum + (s.cpu_avg || 0), 0) / services.length) : 0;
                            const avgMemory = services.length > 0 ? Math.round(services.reduce((sum, s) => sum + (s.memory_avg || 0), 0) / services.length) : 0;

                            return `<div class="cluster-card">
                                <div class="cluster-header" onclick="toggleCluster('${cluster}')">
                                    <div>
                                        <h3 class="cluster-name">üèóÔ∏è ${cluster}</h3>
                                        <div class="cluster-stats">
                                            <span class="cluster-stat">üìä ${totalServices} Services</span>
                                            <span class="cluster-stat">‚úÖ ${activeServices} Active</span>
                                            <span class="cluster-stat">üîß ${totalTasks} Tasks</span>
                                            <span class="cluster-stat">üñ•Ô∏è ${avgCpu}% CPU</span>
                                            <span class="cluster-stat">üíæ ${avgMemory}% Memory</span>
                                        </div>
                                    </div>
                                    <span class="cluster-toggle" id="toggle-${cluster}">‚ñ∂</span>
                                </div>
                                <div class="cluster-content" id="content-${cluster}">
                                    <div class="services-grid">
                                        ${services.map(service =>
                                            `<div class="service-card">
                                                <div class="service-header">
                                                    <h4>‚öôÔ∏è ${service.name}</h4>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <span class="info-icon" onclick="showServiceDetails('${acc.account_id}', '${cluster}', '${service.name}')" title="View detailed service information" style="cursor: pointer; color: #667eea; font-size: 16px; font-weight: bold;">‚ÑπÔ∏è</span>
                                                        <span class="service-status ${service.status}">${service.status}</span>
                                                    </div>
                                                </div>
                                                <div class="service-metrics">
                                                    <div class="metric">
                                                        <span class="metric-label">Tasks:</span>
                                                        <span class="metric-value">${service.running_count}/${service.desired_count}</span>
                                                    </div>
                                                    <div class="metric">
                                                        <span class="metric-label">CPU:</span>
                                                        <span class="metric-value">${service.cpu_avg || 'N/A'}%</span>
                                                    </div>
                                                    <div class="metric">
                                                        <span class="metric-label">Memory:</span>
                                                        <span class="metric-value">${service.memory_avg || 'N/A'}%</span>
                                                    </div>
                                                </div>
                                                <button class="recommend-btn" onclick="getServiceRecommendations('${acc.account_id}', '${cluster}', '${service.name}')">
                                                    ü§ñ Get AI Recommendations
                                                </button>
                                            </div>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="account-actions">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="account-recommend-btn" onclick="getRecommendations('${acc.account_id}')">
                                üìä Get Account-wide Recommendations
                            </button>
                            <button class="refresh-btn" onclick="refreshAccountData('${acc.account_id}')">
                                üîÑ Refresh Data
                            </button>
                            <button class="refresh-btn" onclick="sendEmailNotification('${acc.account_id}')" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24);">
                                üìß Email Report
                            </button>
                            <button class="refresh-btn" onclick="downloadExcelReport('${acc.account_id}')" style="background: linear-gradient(45deg, #28a745, #20c997);">
                                üìä Excel Report
                            </button>
                            <button class="refresh-btn" onclick="expandAllClusters()" style="background: linear-gradient(45deg, #74b9ff, #0984e3);">
                                üîΩ Expand All
                            </button>
                            <button class="refresh-btn" onclick="collapseAllClusters()" style="background: linear-gradient(45deg, #636e72, #2d3436);">
                                üîº Collapse All
                            </button>
                            <a href="/recommendations-dashboard" class="refresh-btn" style="background: linear-gradient(45deg, #a29bfe, #6c5ce7); text-decoration: none; display: inline-block;">
                                üìä View All Recommendations
                            </a>
                        </div>
                        <span class="last-updated">Last updated: ${acc.last_updated}</span>
                    </div>
                </div>`
            ).join('');
        }

        async function getRecommendations(accountId) {
            currentAccountId = accountId;
            showLoading('Getting account-wide recommendations...');
            try {
                const resp = await fetch(`/recommendations/${accountId}`);
                const recs = await resp.json();
                showRecommendations(recs, 'Account-wide Recommendations');
            } catch (error) {
                hideLoading();
                alert('Error getting recommendations: ' + error.message);
            }
        }

        async function getServiceRecommendations(accountId, cluster, service) {
            currentAccountId = accountId;
            showLoading(`Getting recommendations for ${service}...`);
            try {
                const resp = await fetch(`/recommendations/${accountId}/${cluster}/${service}`);
                const recs = await resp.json();
                // Add service and cluster info to recommendations
                recs.service_name = service;
                recs.cluster_name = cluster;
                showRecommendations(recs, `Recommendations for ${service} (${cluster})`);
            } catch (error) {
                hideLoading();
                alert('Error getting service recommendations: ' + error.message);
            }
        }

        function showLoading(message) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `<div class="loading-spinner"></div><p>${message}</p>`;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        let currentAccountId = null;
        let currentRecommendationContext = null;

        function showRecommendations(recs, title) {
            hideLoading();
            const modal = document.getElementById('recommendationsModal');
            const content = document.getElementById('recommendationsContent');
            const chatContainer = document.getElementById('chatContainer');
            document.getElementById('recommendationsTitle').textContent = title;

            // Store context for chat
            currentRecommendationContext = recs;

            if (recs.error) {
                content.innerHTML = `<div class="error">‚ùå ${recs.error}</div>`;
                chatContainer.style.display = 'none';
            } else {
                content.innerHTML = formatRecommendations(recs);
                chatContainer.style.display = 'block';
                document.getElementById('chatMessages').innerHTML = '';
                resetChatHistory();
                setTimeout(initializeChat, 100);
            }

            modal.style.display = 'block';
        }

        function formatRecommendations(recs) {
            console.log('DEBUG: Formatting recommendations:', recs);

            // Handle undefined or null recommendations
            if (!recs || typeof recs !== 'object') {
                return '<div class="error">‚ùå Invalid recommendation data received</div>';
            }

            // Check if this is a service-specific recommendation
            if (recs.service_health) {
                return formatServiceRecommendations(recs);
            }

            // Account-wide recommendations
            const health = recs.overall_health || 'unknown';
            const summary = recs.summary || 'No summary available';

            let html = `<div class="recommendations-summary">
                <h3 style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Overall Health: <span class="health-${health}" style="color: ${health === 'good' ? '#2ecc71' : health === 'warning' ? '#f39c12' : '#e74c3c'}; font-weight: bold;">${health.toUpperCase()}</span></h3>
                <p style="color: white; font-size: 1.1em; line-height: 1.5;">${summary}</p>
            </div>`;

            if (recs.scaling_recommendations && Array.isArray(recs.scaling_recommendations) && recs.scaling_recommendations.length > 0) {
                html += '<h4 style="color: white; margin: 20px 0 15px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">üîÑ Scaling Recommendations:</h4><div class="recommendations-list">';
                recs.scaling_recommendations.forEach(rec => {
                    html += `<div class="recommendation-item" style="color: white;">
                        <strong style="color: #74b9ff;">${rec.service || 'Unknown'} (${rec.cluster || 'Unknown'})</strong>: ${rec.action || 'No action'}<br>
                        <em style="color: rgba(255,255,255,0.9);">${rec.reason || 'No reason provided'}</em>
                    </div>`;
                });
                html += '</div>';
            }

            if (recs.performance_issues && Array.isArray(recs.performance_issues) && recs.performance_issues.length > 0) {
                html += '<h4 style="color: white; margin: 20px 0 15px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">‚ö†Ô∏è Performance Issues:</h4><div class="recommendations-list">';
                recs.performance_issues.forEach(issue => {
                    html += `<div class="recommendation-item severity-${issue.severity || 'medium'}" style="color: white;">
                        <strong style="color: #fd79a8;">${issue.service || 'Unknown'} (${issue.cluster || 'Unknown'})</strong>: ${issue.issue || 'No issue description'}<br>
                        <em style="color: rgba(255,255,255,0.9);">Solution: ${issue.solution || 'No solution provided'}</em>
                    </div>`;
                });
                html += '</div>';
            }

            if (recs.error) {
                html += `<div class="error">‚ùå Error: ${recs.error}</div>`;
            }

            return html;
        }

        function formatServiceRecommendations(recs) {
            const health = recs.service_health || 'unknown';
            const action = recs.scaling_action || 'no_change';
            const reason = recs.reason || 'No analysis available';
            const priority = recs.priority || 'medium';
            const recommendations = recs.recommendations || [];

            let html = `<div class="recommendations-summary">
                <h3 style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Service Health: <span class="health-${health}" style="color: ${health === 'good' ? '#2ecc71' : health === 'warning' ? '#f39c12' : '#e74c3c'}; font-weight: bold;">${health.toUpperCase()}</span></h3>
                <div style="margin: 15px 0;">
                    <strong style="color: white;">Scaling Action:</strong>
                    <span class="action-${action}" style="padding: 6px 12px; border-radius: 8px; background: ${action === 'scale_up' ? 'rgba(231,76,60,0.2)' : action === 'scale_down' ? 'rgba(46,204,113,0.2)' : 'rgba(149,165,166,0.2)'}; color: ${action === 'scale_up' ? '#e74c3c' : action === 'scale_down' ? '#2ecc71' : '#95a5a6'}; font-weight: bold; backdrop-filter: blur(10px);">
                        ${action.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
                <div style="margin: 15px 0;">
                    <strong style="color: white;">Priority:</strong>
                    <span class="priority-${priority}" style="padding: 6px 12px; border-radius: 8px; background: ${priority === 'high' ? 'rgba(231,76,60,0.2)' : priority === 'medium' ? 'rgba(243,156,18,0.2)' : 'rgba(46,204,113,0.2)'}; color: ${priority === 'high' ? '#e74c3c' : priority === 'medium' ? '#f39c12' : '#2ecc71'}; font-weight: bold; backdrop-filter: blur(10px);">
                        ${priority.toUpperCase()}
                    </span>
                </div>
                <p style="margin: 20px 0 0 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; border-left: 4px solid #74b9ff; color: white; line-height: 1.5; backdrop-filter: blur(10px);">${reason}</p>
            </div>`;

            if (recommendations && Array.isArray(recommendations) && recommendations.length > 0) {
                html += '<h4 style="color: white; margin: 20px 0 15px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">üí° Recommendations:</h4><div class="recommendations-list">';
                recommendations.forEach((rec, index) => {
                    html += `<div class="recommendation-item" style="margin-bottom: 12px; color: white;">
                        <span style="font-weight: bold; color: #74b9ff; font-size: 1.1em;">${index + 1}.</span> <span style="color: white; line-height: 1.4;">${rec}</span>
                    </div>`;
                });
                html += '</div>';
            }

            return html;
        }

        function closeModal() {
            document.getElementById('recommendationsModal').style.display = 'none';
            currentAccountId = null;
            currentRecommendationContext = null;
        }

        function closeServiceDetailsModal() {
            document.getElementById('serviceDetailsModal').style.display = 'none';
        }

        async function showServiceDetails(accountId, clusterName, serviceName) {
            showLoading(`Loading details for ${serviceName}...`);
            try {
                const resp = await fetch(`/service-details/${accountId}/${clusterName}/${serviceName}`);
                const details = await resp.json();
                displayServiceDetails(details);
            } catch (error) {
                hideLoading();
                alert('Error loading service details: ' + error.message);
            }
        }

        function displayServiceDetails(details) {
            hideLoading();
            const modal = document.getElementById('serviceDetailsModal');
            const title = document.getElementById('serviceDetailsTitle');
            const content = document.getElementById('serviceDetailsContent');

            title.textContent = `Service Details: ${details.service_name}`;

            let html = `
                <div style="background: rgba(52,73,94,0.8); padding: 25px; border-radius: 20px; margin-bottom: 25px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="color: #74b9ff; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 1.3em;">üìã Basic Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; color: #ecf0f1; font-size: 1.05em;">
                        <div><strong style="color: #3498db;">Service Name:</strong> ${details.service_name}</div>
                        <div><strong style="color: #3498db;">Cluster:</strong> ${details.cluster_name}</div>
                        <div><strong style="color: #3498db;">Status:</strong> <span style="color: ${details.status === 'ACTIVE' ? '#2ecc71' : '#e74c3c'}; font-weight: bold; padding: 4px 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">${details.status}</span></div>
                        <div><strong style="color: #3498db;">Running Tasks:</strong> ${details.running_count}</div>
                        <div><strong style="color: #3498db;">Desired Tasks:</strong> ${details.desired_count}</div>
                        <div><strong style="color: #3498db;">Last Updated:</strong> ${new Date(details.last_updated).toLocaleString()}</div>
                    </div>
                </div>

                <div style="background: rgba(52,73,94,0.8); padding: 25px; border-radius: 20px; margin-bottom: 25px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="color: #fd79a8; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 1.3em;">üìä Resource Metrics</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px;">
                        <div style="background: rgba(116,185,255,0.15); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(116,185,255,0.3);">
                            <h4 style="color: #74b9ff; margin-bottom: 15px; font-weight: bold; font-size: 1.1em;">üñ•Ô∏è CPU Utilization</h4>
                            <div style="font-size: 1.4em; font-weight: bold; color: #ecf0f1; margin-bottom: 8px;">Average: ${details.cpu_avg}%</div>
                            <div style="font-size: 1.2em; color: #bdc3c7;">Maximum: ${details.cpu_max}%</div>
                        </div>
                        <div style="background: rgba(253,121,168,0.15); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(253,121,168,0.3);">
                            <h4 style="color: #fd79a8; margin-bottom: 15px; font-weight: bold; font-size: 1.1em;">üíæ Memory Utilization</h4>
                            <div style="font-size: 1.4em; font-weight: bold; color: #ecf0f1; margin-bottom: 8px;">Average: ${details.memory_avg}%</div>
                            <div style="font-size: 1.2em; color: #bdc3c7;">Maximum: ${details.memory_max}%</div>
                        </div>
                    </div>
                </div>
            `;

            // Add target groups information if available
            if (details.target_groups && Object.keys(details.target_groups).length > 0) {
                html += `
                    <div style="background: rgba(52,73,94,0.8); padding: 25px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);">
                        <h3 style="color: #00b894; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 1.3em;">üéØ Target Groups</h3>
                `;

                Object.entries(details.target_groups).forEach(([tgName, tgData]) => {
                    const errorPercentage = tgData.http_error_percentage || 0;
                    const errorColor = errorPercentage > 10 ? '#e74c3c' : errorPercentage > 5 ? '#f39c12' : '#2ecc71';

                    html += `
                        <div style="background: rgba(0,184,148,0.15); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 4px solid #00b894; backdrop-filter: blur(10px); border: 1px solid rgba(0,184,148,0.3);">
                            <h4 style="color: #00b894; margin-bottom: 15px; font-weight: bold; font-size: 1.1em;">üîó ${tgName}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; color: #ecf0f1; font-size: 1.05em;">
                                <div><strong style="color: #2ecc71;">Healthy Hosts:</strong><br><span style="color: #bdc3c7;">Avg: ${tgData.healthy_hosts_avg || 0} | Max: ${tgData.healthy_hosts_max || 0}</span></div>
                                <div><strong style="color: #e74c3c;">Unhealthy Hosts:</strong><br><span style="color: #bdc3c7;">Avg: ${tgData.unhealthy_hosts_avg || 0} | Max: ${tgData.unhealthy_hosts_max || 0}</span></div>
                                <div><strong style="color: #f39c12;">Response Time:</strong><br><span style="color: #bdc3c7;">Avg: ${tgData.response_time_avg || 0}s | Max: ${tgData.response_time_max || 0}s</span></div>
                                <div><strong style="color: #9b59b6;">Requests:</strong><br><span style="color: #bdc3c7;">Avg: ${tgData.requests_avg || 0} | Max: ${tgData.requests_max || 0}</span></div>
                                <div><strong style="color: ${errorColor};">HTTP Error Rate:</strong><br><span style="color: #bdc3c7;">${errorPercentage}%</span></div>
                                <div><strong style="color: #74b9ff;">HTTP Status Codes:</strong><br><span style="color: #bdc3c7;">2XX: ${tgData.total_2xx_count || 0} | 3XX: ${tgData.total_3xx_count || 0} | 4XX: ${tgData.total_4xx_count || 0}</span></div>
                            </div>
                        </div>
                    `;
                });

                // Add HTTP metrics explanation
                html += `
                    <div style="background: rgba(116,185,255,0.15); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #74b9ff; backdrop-filter: blur(10px); border: 1px solid rgba(116,185,255,0.3);">
                        <p style="color: #ecf0f1; font-size: 0.95em; line-height: 1.4; margin: 0;"><strong style="color: #74b9ff;">üìä HTTP Metrics:</strong> Error rate calculated as (3XX + 4XX) / 2XX * 100. Status codes show total counts over the monitoring period.</p>
                    </div>
                `;

                html += '</div>';
            } else {
                html += `
                    <div style="background: rgba(52,73,94,0.8); padding: 25px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);">
                        <div style="background: rgba(243,156,18,0.15); padding: 20px; border-radius: 15px; border-left: 4px solid #f39c12; backdrop-filter: blur(10px); border: 1px solid rgba(243,156,18,0.3);">
                            <strong style="color: #f39c12; font-size: 1.1em;">‚ö†Ô∏è No Target Groups:</strong> <span style="color: #ecf0f1; font-size: 1.05em;">This service is not associated with any Application Load Balancer target groups.</span>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        async function sendChatMessage() {
            if (!currentAccountId) {
                alert('No account context available');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');
            const sendBtn = document.getElementById('chatSendBtn');

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                const response = await fetch(`/chat/${currentAccountId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        context: currentRecommendationContext
                    })
                });

                const result = await response.json();
                addChatMessage(result.response, 'ai');
            } catch (error) {
                addChatMessage('Sorry, I encountered an error processing your message.', 'ai');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;

            // Format AI messages with markdown-like styling
            let formattedMessage = message;
            if (sender === 'ai') {
                formattedMessage = message
                    .replace(/# (.*?)\n/g, '<h3 style="color: #667eea; margin: 15px 0 10px 0; font-size: 1.1em;">$1</h3>')
                    .replace(/## (.*?)\n/g, '<h4 style="color: #333; margin: 12px 0 8px 0; font-size: 1em; font-weight: bold;">$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #333;">$1</strong>')
                    .replace(/- (.*?)\n/g, '<div style="margin: 5px 0; padding-left: 15px;">‚Ä¢ $1</div>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
            }

            messageDiv.innerHTML = `<div class="message-bubble ${sender}">${formattedMessage}</div>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function initializeChat() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages.children.length === 0) {
                // Create context-aware welcome message
                let welcomeMsg = 'Hi! I\'m your ECS AI assistant. ';

                if (currentRecommendationContext) {
                    if (currentRecommendationContext.service_name && currentRecommendationContext.cluster_name) {
                        welcomeMsg += `I can see we\'re discussing ECS service **${currentRecommendationContext.service_name}** in cluster **${currentRecommendationContext.cluster_name}**`;
                        if (currentRecommendationContext.service_health) {
                            welcomeMsg += ` with **${currentRecommendationContext.service_health}** health status`;
                        }
                        if (currentRecommendationContext.scaling_action) {
                            welcomeMsg += ` that needs **${currentRecommendationContext.scaling_action.replace('_', ' ')}**`;
                        }
                        if (currentRecommendationContext.recommendations && currentRecommendationContext.recommendations.length > 0) {
                            welcomeMsg += `. I\'ve provided ${currentRecommendationContext.recommendations.length} specific recommendations`;
                        }
                        welcomeMsg += '. ';
                    } else if (currentRecommendationContext.overall_health) {
                        welcomeMsg += `I can see your account has **${currentRecommendationContext.overall_health}** overall health`;
                        if (currentRecommendationContext.scaling_recommendations && currentRecommendationContext.scaling_recommendations.length > 0) {
                            const firstRec = currentRecommendationContext.scaling_recommendations[0];
                            if (firstRec.service && firstRec.cluster) {
                                welcomeMsg += ` with recommendations for service **${firstRec.service}** in cluster **${firstRec.cluster}**`;
                            }
                        }
                        welcomeMsg += '. ';
                    }
                }

                welcomeMsg += 'Ask me about the recommendations above, scaling scenarios, CPU/memory optimization, or any ECS questions!';
                addChatMessage(welcomeMsg, 'ai');
            }
        }

        async function resetChatHistory() {
            if (!currentAccountId) return;

            try {
                await fetch(`/chat/${currentAccountId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: 'reset',
                        context: currentRecommendationContext,
                        reset_chat: true
                    })
                });
            } catch (error) {
                console.log('Chat reset failed:', error);
            }
        }

        async function refreshAccountData(accountId) {
            showLoading('Refreshing account data...');
            try {
                const resp = await fetch(`/accounts/${accountId}/refresh`, {method: 'POST'});
                const result = await resp.json();
                hideLoading();
                if (result.status === 'success') {
                    alert('‚úÖ Account data refreshed successfully!');
                    loadAccounts(); // Reload the accounts display
                } else {
                    alert('‚ùå Error refreshing data: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                hideLoading();
                alert('‚ùå Error refreshing account data: ' + error.message);
            }
        }

        async function sendEmailNotification(accountId) {
            const email = prompt('Enter email address to send recommendations:');
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            showLoading('Sending email notification...');
            try {
                const resp = await fetch(`/send-email/${accountId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email, account_id: accountId})
                });
                const result = await resp.json();
                hideLoading();
                if (result.status === 'success') {
                    alert('‚úÖ Email sent successfully!');
                } else {
                    alert('‚ùå Error sending email: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                hideLoading();
                alert('‚ùå Error sending email: ' + error.message);
            }
        }

        async function downloadExcelReport(accountId) {
            showLoading('Generating Excel report...');
            try {
                const response = await fetch(`/export-excel/${accountId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'ECS_Report.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    hideLoading();
                    alert('‚úÖ Excel report downloaded successfully!');
                } else {
                    const error = await response.json();
                    hideLoading();
                    alert('‚ùå Error generating report: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                hideLoading();
                alert('‚ùå Error downloading report: ' + error.message);
            }
        }

        function toggleCluster(clusterId) {
            const content = document.getElementById(`content-${clusterId}`);
            const toggle = document.getElementById(`toggle-${clusterId}`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '‚ñ∂';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '‚ñº';
            }
        }

        function expandAllClusters() {
            document.querySelectorAll('.cluster-content').forEach(content => {
                content.classList.add('expanded');
            });
            document.querySelectorAll('.cluster-toggle').forEach(toggle => {
                toggle.classList.add('expanded');
                toggle.textContent = '‚ñº';
            });
        }

        function collapseAllClusters() {
            document.querySelectorAll('.cluster-content').forEach(content => {
                content.classList.remove('expanded');
            });
            document.querySelectorAll('.cluster-toggle').forEach(toggle => {
                toggle.classList.remove('expanded');
                toggle.textContent = '‚ñ∂';
            });
        }

        async function loadUserInfo() {
            try {
                const resp = await fetch('/user-info');
                const userInfo = await resp.json();
                document.getElementById('userName').textContent = userInfo.name;
                document.getElementById('userEmail').textContent = userInfo.email;
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('userName').textContent = 'Unknown User';
                document.getElementById('userEmail').textContent = 'unknown@example.com';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        loadUserInfo();
        loadAccounts();
        setInterval(loadAccounts, 30000);
    </script>
</body>
</html>
