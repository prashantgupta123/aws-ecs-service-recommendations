<!DOCTYPE html>
<html>
<head>
    <title>ECS Cluster Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2c3e50 0%, #34495e 25%, #2c3e50 50%, #34495e 75%, #2c3e50 100%); background-size: 400% 400%; animation: gradientShift 15s ease infinite; min-height: 100vh; margin: 0; display: flex; }
        .sidebar { width: 250px; background: rgba(44,62,80,0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); position: fixed; height: 100vh; z-index: 100; transition: all 0.3s; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-title { color: #74b9ff; font-size: 1.3em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .sidebar-nav { padding: 20px 0; }
        .nav-item { display: block; padding: 15px 25px; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; border-left-color: #74b9ff; }
        .nav-item.active { background: rgba(116,185,255,0.2); color: #74b9ff; border-left-color: #74b9ff; }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }
        .main-content { margin-left: 250px; flex: 1; padding: 20px; }
        .sidebar-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 101; background: rgba(116,185,255,0.2); color: #74b9ff; border: 1px solid rgba(116,185,255,0.4); padding: 10px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(10px); }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { display: block; }
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container { max-width: 1400px; margin: 0 auto; width: 100%; }
        .header { text-align: center; color: #2c3e50; margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); color: white; }
        .header p { color: rgba(255,255,255,0.9); font-size: 1.1em; }
        .form-section { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 30px; }
        .form-title { color: #74b9ff; font-size: 1.4em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); margin-bottom: 25px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; background: rgba(255,255,255,0.1); color: white; font-size: 1em; transition: all 0.3s; }
        .form-control:focus { outline: none; border-color: #74b9ff; box-shadow: 0 0 10px rgba(116,185,255,0.3); background: rgba(255,255,255,0.15); }
        .form-control option { background: #2c3e50; color: white; }
        .btn { padding: 12px 25px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); color: white; box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
        .btn-success { background: linear-gradient(45deg, #00cec9, #00b894); color: white; box-shadow: 0 5px 15px rgba(0,206,201,0.3); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,206,201,0.4); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: white; }
        .results-section { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 30px; display: none; }
        .results-title { color: #74b9ff; font-size: 1.4em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); margin-bottom: 25px; text-align: center; }
        .service-card { background: rgba(44,62,80,0.9); border-radius: 15px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(116,185,255,0.3); transition: all 0.3s; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .service-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.3); background: rgba(44,62,80,0.95); }
        .service-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .service-name { color: #74b9ff; font-weight: bold; font-size: 1.2em; }
        .service-badges { display: flex; gap: 8px; margin-bottom: 15px; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .badge-health-good { background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid rgba(46,204,113,0.4); }
        .badge-health-warning { background: rgba(243,156,18,0.2); color: #f39c12; border: 1px solid rgba(243,156,18,0.4); }
        .badge-health-critical { background: rgba(231,76,60,0.2); color: #e74c3c; border: 1px solid rgba(231,76,60,0.4); }
        .badge-health-error { background: rgba(231,76,60,0.2); color: #e74c3c; border: 1px solid rgba(231,76,60,0.4); }
        .badge-priority-high { background: rgba(231,76,60,0.2); color: #e74c3c; border: 1px solid rgba(231,76,60,0.4); }
        .badge-priority-medium { background: rgba(243,156,18,0.2); color: #f39c12; border: 1px solid rgba(243,156,18,0.4); }
        .badge-priority-low { background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid rgba(46,204,113,0.4); }
        .badge-scaling-scale_up { background: rgba(231,76,60,0.2); color: #e74c3c; border: 1px solid rgba(231,76,60,0.4); }
        .badge-scaling-scale_down { background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid rgba(46,204,113,0.4); }
        .badge-scaling-no_change { background: rgba(149,165,166,0.2); color: #95a5a6; border: 1px solid rgba(149,165,166,0.4); }
        .recommendations-list { color: rgba(255,255,255,0.9); }
        .recommendations-list ul { margin: 10px 0; padding-left: 20px; }
        .recommendations-list li { margin: 5px 0; line-height: 1.4; }
        .error-message { background: rgba(231,76,60,0.2); color: #e74c3c; border: 1px solid rgba(231,76,60,0.4); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .success-message { background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid rgba(46,204,113,0.4); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üèóÔ∏è ECS Monitor</div>
        </div>
        <nav class="sidebar-nav">
            <a href="/" class="nav-item">
                <i>üìà</i> Analytics
            </a>
            <a href="/services-dashboard" class="nav-item">
                <i>üè†</i> Services
            </a>
            <a href="/recommendations-dashboard" class="nav-item">
                <i>üìä</i> Recommendations
            </a>
            <a href="/cluster-dashboard" class="nav-item active">
                <i>üéØ</i> Cluster Analysis
            </a>
            <a href="/add-account" class="nav-item">
                <i>‚ûï</i> Add Account
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>üéØ Cluster Analysis Dashboard</h1>
                <p>Generate AI-Powered Recommendations for Specific ECS Clusters</p>
            </div>

            <!-- Form Section -->
            <div class="form-section">
                <h3 class="form-title">üîç Select Cluster for Analysis</h3>
                <form id="clusterForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="accountSelect">AWS Account</label>
                            <select id="accountSelect" class="form-control" required>
                                <option value="">Loading accounts...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="clusterName">ECS Cluster Name</label>
                            <input type="text" id="clusterName" class="form-control" placeholder="Enter cluster name (e.g., production-cluster)" required>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 25px;">
                        <button type="submit" class="btn btn-primary">üöÄ Generate Cluster Recommendations</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h3 class="results-title">üìã Cluster Analysis Results</h3>
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let accounts = [];

        async function loadAccounts() {
            try {
                const response = await fetch('/accounts');
                const data = await response.json();

                // Handle both array and paginated response formats
                accounts = Array.isArray(data) ? data : data.accounts || [];

                const accountSelect = document.getElementById('accountSelect');
                accountSelect.innerHTML = '<option value="">Select an account...</option>';

                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.account_id;
                    option.textContent = `${account.account_name} (${account.account_id})`;
                    accountSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading accounts:', error);
                document.getElementById('accountSelect').innerHTML = '<option value="">Error loading accounts</option>';
            }
        }

        async function generateClusterRecommendations(accountId, clusterName) {
            try {
                showLoading();

                const response = await fetch(`/cluster-recommendations/${accountId}/${encodeURIComponent(clusterName)}`);
                const data = await response.json();

                if (data.error || !response.ok) {
                    const errorMsg = data.detail || data.error || 'Unknown error';
                    showError(`Error: ${errorMsg}`);
                    return;
                }

                displayResults(accountId, clusterName, data.services, data);

            } catch (error) {
                console.error('Error generating recommendations:', error);
                showError(`Failed to generate recommendations: ${error.message}`);
            }
        }

        function displayResults(accountId, clusterName, services, fullData) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            // Get account name
            const account = accounts.find(acc => acc.account_id === accountId);
            const accountName = account ? account.account_name : accountId;

            // Use summary from API response or calculate if not available
            const summary = fullData.summary || {};
            const totalServices = services.length;
            const healthCounts = summary.health_distribution || { good: 0, warning: 0, critical: 0, error: 0 };
            const priorityCounts = summary.priority_distribution || { high: 0, medium: 0, low: 0 };
            const scalingCounts = summary.scaling_distribution || { scale_up: 0, scale_down: 0, no_change: 0 };

            resultsContent.innerHTML = `
                <!-- Summary Section -->
                <div style="background: rgba(116,185,255,0.1); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(116,185,255,0.3);">
                    <h4 style="color: #74b9ff; margin-bottom: 20px; text-align: center; font-size: 1.3em;">üìä Cluster Summary</h4>

                    <!-- First Row: Basic Info -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; text-align: center;">
                        <div style="background: rgba(44,62,80,0.6); padding: 15px; border-radius: 12px; border: 1px solid rgba(116,185,255,0.2);">
                            <div style="color: #74b9ff; font-weight: bold; font-size: 0.9em; margin-bottom: 8px;">üè¢ Account</div>
                            <div style="color: white; font-size: 1.1em; font-weight: 600;">${accountName}</div>
                        </div>
                        <div style="background: rgba(44,62,80,0.6); padding: 15px; border-radius: 12px; border: 1px solid rgba(116,185,255,0.2);">
                            <div style="color: #74b9ff; font-weight: bold; font-size: 0.9em; margin-bottom: 8px;">üéØ Cluster</div>
                            <div style="color: white; font-size: 1.1em; font-weight: 600;">${clusterName}</div>
                        </div>
                        <div style="background: rgba(44,62,80,0.6); padding: 15px; border-radius: 12px; border: 1px solid rgba(116,185,255,0.2);">
                            <div style="color: #74b9ff; font-weight: bold; font-size: 0.9em; margin-bottom: 8px;">‚öôÔ∏è Total Services</div>
                            <div style="color: white; font-size: 1.3em; font-weight: bold;">${totalServices}</div>
                        </div>
                    </div>

                    <!-- Second Row: Status & Actions -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                        <div style="background: rgba(231,76,60,0.15); padding: 12px; border-radius: 10px; border: 1px solid rgba(231,76,60,0.3);">
                            <div style="color: #e74c3c; font-weight: bold; font-size: 0.85em; margin-bottom: 6px;">üö® Critical/Error</div>
                            <div style="color: #e74c3c; font-size: 1.4em; font-weight: bold;">${healthCounts.critical + healthCounts.error}</div>
                        </div>
                        <div style="background: rgba(243,156,18,0.15); padding: 12px; border-radius: 10px; border: 1px solid rgba(243,156,18,0.3);">
                            <div style="color: #f39c12; font-weight: bold; font-size: 0.85em; margin-bottom: 6px;">üî¥ High Priority</div>
                            <div style="color: #f39c12; font-size: 1.4em; font-weight: bold;">${priorityCounts.high}</div>
                        </div>
                        <div style="background: rgba(155,89,182,0.15); padding: 12px; border-radius: 10px; border: 1px solid rgba(155,89,182,0.3);">
                            <div style="color: #9b59b6; font-weight: bold; font-size: 0.85em; margin-bottom: 6px;">üìà Scale Up</div>
                            <div style="color: #9b59b6; font-size: 1.4em; font-weight: bold;">${scalingCounts.scale_up}</div>
                        </div>
                        <div style="background: rgba(46,204,113,0.15); padding: 12px; border-radius: 10px; border: 1px solid rgba(46,204,113,0.3);">
                            <div style="color: #2ecc71; font-weight: bold; font-size: 0.85em; margin-bottom: 6px;">üìâ Scale Down</div>
                            <div style="color: #2ecc71; font-size: 1.4em; font-weight: bold;">${scalingCounts.scale_down}</div>
                        </div>
                    </div>
                </div>

                <!-- Services List -->
                <div id="servicesList">
                    ${services.map(service => createServiceCard(service)).join('')}
                </div>
            `;

            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function createServiceCard(service) {
            const recommendations = service.recommendations || [];
            const fullRec = service.full_recommendation || {};
            const detailedRecs = fullRec.recommendations || [];

            return `
                <div class="service-card">
                    <div class="service-header">
                        <div class="service-name">üîß ${service.service_name}</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">
                            ${new Date().toLocaleDateString()}
                        </div>
                    </div>

                    <div class="service-badges">
                        <span class="badge badge-health-${service.service_health || 'unknown'}">${(service.service_health || 'unknown').toUpperCase()}</span>
                        <span class="badge badge-priority-${service.priority || 'medium'}">${(service.priority || 'medium').toUpperCase()}</span>
                        <span class="badge badge-scaling-${service.scaling_action || 'no_change'}">${(service.scaling_action || 'no_change').replace('_', ' ').toUpperCase()}</span>
                    </div>

                    ${service.reason ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #74b9ff;">
                            <strong style="color: #74b9ff;">Analysis:</strong>
                            <div style="color: rgba(255,255,255,0.9); margin-top: 5px;">${service.reason}</div>
                        </div>
                    ` : ''}

                    <div class="recommendations-list">
                        <strong style="color: #74b9ff;">ü§ñ AI Recommendations:</strong>
                        ${detailedRecs.length > 0 ? `
                            <ul>
                                ${detailedRecs.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        ` : '<div style="color: rgba(255,255,255,0.6); font-style: italic; margin-top: 8px;">No specific recommendations available</div>'}
                    </div>

                    ${service.service_details ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9em; margin-bottom: 10px;">
                                <div><strong>Status:</strong> <span style="color: ${service.service_details.status === 'ACTIVE' ? '#2ecc71' : '#e74c3c'};">${service.service_details.status}</span></div>
                                <div><strong>Tasks:</strong> ${service.service_details.running_count}/${service.service_details.desired_count}</div>
                                <div><strong>CPU Avg:</strong> ${service.service_details.cpu_avg || 'N/A'}%</div>
                                <div><strong>Memory Avg:</strong> ${service.service_details.memory_avg || 'N/A'}%</div>
                            </div>
                            ${Object.keys(service.service_details.target_groups || {}).length > 0 ? `
                                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-top: 10px;">
                                    <strong style="color: #74b9ff; font-size: 0.9em;">üéØ Target Group Metrics:</strong>
                                    ${Object.entries(service.service_details.target_groups).map(([tgName, tgData]) => `
                                        <div style="margin-top: 8px; padding: 8px; background: rgba(44,62,80,0.4); border-radius: 6px;">
                                            <div style="color: #74b9ff; font-weight: bold; font-size: 0.85em; margin-bottom: 6px;">${tgName}</div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.8em;">
                                                <div><strong>Requests:</strong> ${tgData.requests_avg || 0}/period</div>
                                                <div><strong>Response:</strong> ${(tgData.response_time_avg || 0).toFixed(3)}s</div>
                                                <div><strong>Error Rate:</strong> <span style="color: ${(tgData.http_error_percentage || 0) > 5 ? '#e74c3c' : '#2ecc71'};">${(tgData.http_error_percentage || 0).toFixed(1)}%</span></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showLoading() {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px;">Generating AI recommendations for cluster services...</p>
                    <p style="font-size: 0.9em; color: rgba(255,255,255,0.7); margin-top: 10px;">This may take a few moments</p>
                </div>
            `;
            document.getElementById('resultsSection').style.display = 'block';
        }

        function showError(message) {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="error-message">
                    <strong>‚ùå Error</strong><br>
                    ${message}
                </div>
            `;
            document.getElementById('resultsSection').style.display = 'block';
        }

        function showSuccess(message) {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="success-message">
                    <strong>‚úÖ Success</strong><br>
                    ${message}
                </div>
            `;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Form submission handler
        document.getElementById('clusterForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const accountId = document.getElementById('accountSelect').value;
            const clusterName = document.getElementById('clusterName').value.trim();

            if (!accountId) {
                showError('Please select an AWS account');
                return;
            }

            if (!clusterName) {
                showError('Please enter a cluster name');
                return;
            }

            await generateClusterRecommendations(accountId, clusterName);
        });

        // Initialize page
        loadAccounts();
    </script>
</body>
</html>
